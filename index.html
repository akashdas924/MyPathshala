<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Pathshala - Ultimate All-in-One Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        :root {
            --chakra-blue: #000080;
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
            --text-main: #1d1d1f;
            --success: #27ae60;
        }
        body { 
            margin: 0; 
            min-height: 100vh; 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(180deg, #FF9933 0%, #FFFFFF 50%, #138808 100%); 
            background-attachment: fixed;
            position: relative;
            overflow-x: hidden;
        }
        .chakra-bg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; height: 400px; z-index: -1; opacity: 0.15; animation: rotateChakra 20s linear infinite; }
        @keyframes rotateChakra { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .container { max-width: 1200px; margin: 20px auto; padding: 30px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(15px); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); position: relative; z-index: 1; }
        .glass-card { background: rgba(255, 255, 255, 0.6); border-radius: 20px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(255, 255, 255, 0.5); }
        .apple-btn { background: var(--chakra-blue); color: white; padding: 12px 25px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-approve { background: var(--success) !important; color: white; border-radius: 8px; padding: 8px 15px; }
        .btn-disabled { opacity: 0.2; cursor: not-allowed; pointer-events: none; }
        .rank-1 { background: var(--gold) !important; font-weight: bold; }
        .rank-2 { background: var(--silver) !important; }
        .rank-3 { background: var(--bronze) !important; color: white; }
        .marquee-box { overflow: hidden; background: rgba(0, 0, 128, 0.05); padding: 10px 0; border-radius: 10px; margin: 20px 0; }
        .moving-text { display: inline-block; white-space: nowrap; animation: marquee 20s linear infinite; color: var(--chakra-blue); font-weight: 600; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .pass-wrapper { position: relative; width: 100%; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--chakra-blue); }
        input, select, textarea { background: rgba(255, 255, 255, 0.8); border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin: 10px 0; width: 95%; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; text-align: center; }
        th { background: rgba(0, 0, 128, 0.1); padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        #clock { font-size: 1.2rem; font-weight: bold; color: var(--chakra-blue); text-align: right; }
    </style>
</head>
<body>

<svg class="chakra-bg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <circle cx="100" cy="100" r="95" fill="none" stroke="#000080" stroke-width="2"/>
    <circle cx="100" cy="100" r="85" fill="none" stroke="#000080" stroke-width="1"/>
    <circle cx="100" cy="100" r="8" fill="#000080"/>
    <g id="spokes" stroke="#000080" stroke-width="2"></g>
</svg>

<div class="container">
    <div id="clock">00:00:00</div>
    <h1 style="text-align: center; font-size: 3rem; margin: 0; background: linear-gradient(90deg, #FF9933, #000080, #138808); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Pathshala.</h1>

    <div id="publicView">
        <div style="display: grid; grid-template-columns: 1.3fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="glass-card">
                <h3 style="color: var(--chakra-blue); text-align: center;"><i class="fa-solid fa-trophy"></i> Public Rank List</h3>
                <center>
                    <select id="rankClassSelect" onchange="renderRankList()" style="width: 180px;">
                        <option value="6">Class 6</option><option value="7">Class 7</option>
                        <option value="8">Class 8</option><option value="9">Class 9</option><option value="10">Class 10</option>
                    </select>
                </center>
                <table>
                    <thead><tr><th>Rank</th><th>Name</th><th>Average (%)</th></tr></thead>
                    <tbody id="rankListBody"></tbody>
                </table>
            </div>

            <div class="glass-card" style="text-align: center;">
                <div id="loginForm">
                    <h3>Sign In</h3>
                    <input type="text" id="lUser" placeholder="Full Name (Login ID)">
                    <div class="pass-wrapper">
                        <input type="password" id="lPass" placeholder="Password">
                        <i class="fa-solid fa-eye toggle-password" onclick="togglePass('lPass', this)"></i>
                    </div>
                    <button class="apple-btn" style="width: 100%; margin-top: 15px;" onclick="handleLogin()">Login</button>
                    <p id="pendingMsg" style="color:red; font-size:12px; display:none;">Waiting for Admin approval...</p>
                    <p>‡¶®‡¶§‡ßÅ‡¶®? <a href="#" onclick="toggleAuth(true)">Registration ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
                </div>

                <div id="regForm" class="hidden">
                    <h3>Registration</h3>
                    <input type="text" id="rName" placeholder="Full Name (Login ID)">
                    <input type="text" id="rPhone" placeholder="WhatsApp No">
                    <select id="rClass">
                        <option value="">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
                        <option value="9">9</option><option value="10">10</option>
                    </select>
                    <div style="margin: 10px 0;">
                        <label><input type="radio" name="g" value="Male" checked> Male</label>
                        <label><input type="radio" name="g" value="Female"> Female</label>
                    </div>
                    <div class="pass-wrapper">
                        <input type="password" id="rPass" placeholder="Password">
                        <i class="fa-solid fa-eye toggle-password" onclick="togglePass('rPass', this)"></i>
                    </div>
                    <button class="apple-btn" style="width: 100%; margin-top: 10px;" onclick="handleRegister()">Submit Request</button>
                    <p><a href="#" onclick="toggleAuth(false)">Back</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="hidden">
        <button class="apple-btn" style="float: right; background: #c0392b;" onclick="location.reload()">Logout</button>
        <h2>Admin Console.</h2>
        <div class="glass-card">
            <h4>üì© Registration Approvals</h4>
            <table><thead><tr><th>Name</th><th>Pass</th><th>Class</th><th>Action</th></tr></thead><tbody id="approvalBody"></tbody></table>
        </div>
        <div class="glass-card">
            <h4>üì¢ Moving Notice Board</h4>
            <textarea id="noticeInput" rows="2" placeholder="Write announcement..."></textarea>
            <button class="apple-btn" onclick="postNotice()">Update Notice</button>
        </div>
        <div class="glass-card">
            <h4>üìä Upload Results</h4>
            <select id="resClass" onchange="filterStudents()"><option value="">Class</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select>
            <select id="resUserSelect"><option value="">Select Student</option></select>
            <select id="resSub"><option value="">Subject</option></select>
            <input type="number" id="resOb" placeholder="Obtained" oninput="calcPerc()"><input type="number" id="resFull" placeholder="Total" oninput="calcPerc()"><input type="text" id="resPerc" placeholder="%" readonly>
            <button class="apple-btn" onclick="uploadResult()">Upload & Send WhatsApp</button>
        </div>
        <div class="glass-card">
            <h4>üë• Attendance & Control</h4>
            <table><thead><tr><th>Name</th><th>Class</th><th>P/T</th><th>Mark</th><th>Action</th></tr></thead><tbody id="masterBody"></tbody></table>
        </div>
    </div>

    <div id="studentPanel" class="hidden">
        <button class="apple-btn" style="float: right; background: #c0392b;" onclick="location.reload()">Logout</button>
        <h2>Welcome, <span id="studentDisplayName"></span>!</h2>
        <div class="marquee-box"><div class="moving-text" id="noticeDisplay"></div></div>
        <div style="display: grid; grid-template-columns: 1fr 2.5fr; gap: 20px;">
            <div class="glass-card" style="text-align: center;"><p>Attendance</p><div id="attPerc" style="font-size: 3rem; font-weight: 800; color:var(--chakra-blue)">0%</div></div>
            <div class="glass-card">
                <h4>Performance</h4>
                <table id="resultTable"><thead><tr><th>Subject</th><th>Marks</th><th>%</th><th>Grade</th></tr></thead><tbody id="studentBody"></tbody></table>
                <button class="apple-btn" style="margin-top: 20px;" onclick="downloadPDF()">Download PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyB-x775vC8HW-juNWOkLyeU8KOTwMzd8Rg",
        authDomain: "pathshala-online-94c96.firebaseapp.com",
        databaseURL: "https://pathshala-online-94c96-default-rtdb.firebaseio.com",
        projectId: "pathshala-online-94c96",
        storageBucket: "pathshala-online-94c96.firebasestorage.app",
        messagingSenderId: "132374932318",
        appId: "1:132374932318:web:01faa07d92f367c90d3dcf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Global variables
    let students = {};
    let results = [];
    let att = {};
    let currentNotice = "";

    // REAL-TIME DATA SYNC
    db.ref('/').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        students = data.students || { 'admin': { pw: '123', role: 'admin', approved: true } };
        results = data.results || [];
        att = data.attendance || {};
        currentNotice = data.notice || "Welcome to Pathshala!";
        
        renderRankList();
        if(window.currentUser === 'Admin') renderAdmin();
        else if(window.currentUser) refreshStudentUI();
    });

    // Clock & Spokes
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    const spokes = document.getElementById('spokes');
    for (let i = 0; i < 24; i++) {
        const angle = i * 15 * Math.PI / 180;
        const x2 = 100 + 85 * Math.cos(angle);
        const y2 = 100 + 85 * Math.sin(angle);
        spokes.innerHTML += `<line x1="100" y1="100" x2="${x2}" y2="${y2}" />`;
    }

    function togglePass(id, icon) { const input = document.getElementById(id); input.type = input.type === "password" ? "text" : "password"; icon.classList.toggle('fa-eye-slash'); }
    function toggleAuth(show) { document.getElementById('loginForm').classList.toggle('hidden', show); document.getElementById('regForm').classList.toggle('hidden', !show); }

    function handleLogin() {
        let u = document.getElementById('lUser').value.trim();
        let p = document.getElementById('lPass').value;
        if(u.toLowerCase() === 'admin' && p === '123') {
            window.currentUser = 'Admin';
            document.getElementById('publicView').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            renderAdmin();
        } else if(students[u] && students[u].pw === p) {
            if(!students[u].approved) { document.getElementById('pendingMsg').style.display = "block"; return; }
            window.currentUser = u;
            document.getElementById('publicView').classList.add('hidden');
            document.getElementById('studentPanel').classList.remove('hidden');
            refreshStudentUI();
        } else alert("Invalid Login!");
    }

    function handleRegister() {
        let n = document.getElementById('rName').value.trim(), ph = document.getElementById('rPhone').value, c = document.getElementById('rClass').value, pw = document.getElementById('rPass').value;
        let g = document.querySelector('input[name="g"]:checked')?.value;
        if(!n || !ph || !c || !pw) return alert("Fill all fields!");
        db.ref('students/' + n).set({ pw, role: 'student', phone: ph, class: c, gender: g, approved: false })
        .then(() => { alert("Requested! Wait for admin approval."); toggleAuth(false); });
    }

    function renderRankList() {
        const cls = document.getElementById('rankClassSelect').value;
        let data = [];
        for (let u in students) {
            if (students[u].role !== 'admin' && students[u].class === cls && students[u].approved) {
                let res = results.filter(r => r.user === u);
                if (res.length > 0) {
                    let avg = res.reduce((sum, r) => sum + parseFloat(r.perc), 0) / res.length;
                    data.push({ name: u, avg: avg });
                }
            }
        }
        data.sort((a, b) => b.avg - a.avg);
        document.getElementById('rankListBody').innerHTML = data.map((s, i) => `
            <tr class="${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}"><td>${i + 1}</td><td>${s.name}</td><td>${s.avg.toFixed(2)}%</td></tr>
        `).join('') || "<tr><td colspan='3'>No data.</td></tr>";
    }

    function renderAdmin() {
        let appHtml = "", masterHtml = "";
        const date = new Date().toLocaleDateString();
        const session = new Date().getHours() < 12 ? "AM" : "PM";
        for(let u in students) {
            if(students[u].role === 'admin') continue;
            if(!students[u].approved) {
                appHtml += `<tr><td>${u}</td><td>${students[u].pw}</td><td>${students[u].class}</td><td><button onclick="db.ref('students/${u}/approved').set(true)" class="apple-btn btn-approve">Approve</button></td></tr>`;
            } else {
                let r = att[u] || { p: 0, t: 0, lastD: "", lastS: "" };
                let lock = (r.lastD === date && r.lastS === session);
                masterHtml += `<tr><td>${u}</td><td>${students[u].class}</td><td>${r.p}/${r.t}</td><td><button onclick="markAtt('${u}')" class="apple-btn ${lock?'btn-disabled':''}">P</button></td><td><button onclick="db.ref('students/${u}').remove()" class="apple-btn" style="background:#e74c3c">X</button></td></tr>`;
            }
        }
        document.getElementById('approvalBody').innerHTML = appHtml || "<tr><td colspan='4'>No requests.</td></tr>";
        document.getElementById('masterBody').innerHTML = masterHtml;
    }

    function markAtt(u) {
        let r = att[u] || { p: 0, t: 0 };
        db.ref('attendance/' + u).update({ p: r.p + 1, t: r.t + 1, lastD: new Date().toLocaleDateString(), lastS: new Date().getHours() < 12 ? "AM" : "PM" });
    }

    function postNotice() { db.ref('notice').set(document.getElementById('noticeInput').value); alert("Notice Sent!"); }

    function filterStudents() {
        const cls = document.getElementById('resClass').value;
        const sSelect = document.getElementById('resUserSelect');
        sSelect.innerHTML = '<option value="">Student</option>';
        for (let u in students) if(students[u].class === cls && students[u].approved) sSelect.innerHTML += `<option value="${u}">${u}</option>`;
        let subs = (cls >= 6 && cls <= 8) ? ["Bengali", "English", "Math", "ENVS", "History", "Geography"] : ["Bengali", "English", "Math", "Phys Sci", "Life Sci", "History", "Geography"];
        document.getElementById('resSub').innerHTML = subs.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function calcPerc() {
        let ob = document.getElementById('resOb').value, fl = document.getElementById('resFull').value;
        if(ob && fl) document.getElementById('resPerc').value = ((ob/fl)*100).toFixed(2) + "%";
    }

    function uploadResult() {
        let u = document.getElementById('resUserSelect').value, sub = document.getElementById('resSub').value, ob = document.getElementById('resOb').value, fl = document.getElementById('resFull').value;
        if(!u || !sub || !ob || !fl) return alert("Empty fields!");
        let p = (ob/fl)*100;
        let newRes = [...results, { user:u, sub, ob, fl, perc: p.toFixed(2), grade: p>=80?'A+':p>=60?'A':p>=40?'B':'F' }];
        db.ref('results').set(newRes).then(() => {
            window.open(`https://wa.me/${students[u].phone}?text=Result: ${sub} Score: ${ob}/${fl} Grade: ${p>=80?'A+':'B'}`);
        });
    }

    function refreshStudentUI() {
        document.getElementById('studentDisplayName').innerText = window.currentUser;
        document.getElementById('noticeDisplay').innerText = currentNotice;
        let myRes = results.filter(r => r.user === window.currentUser);
        document.getElementById('studentBody').innerHTML = myRes.map(r => `<tr><td>${r.sub}</td><td>${r.ob}/${r.fl}</td><td>${r.perc}%</td><td>${r.grade}</td></tr>`).join('');
        let r = att[window.currentUser] || { p: 0, t: 0 };
        document.getElementById('attPerc').innerText = (r.t === 0 ? 0 : Math.round((r.p/r.t)*100)) + "%";
    }

    async function downloadPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Pathshala Report", 14, 20); doc.autoTable({ startY: 30, html: '#resultTable' }); doc.save("Result.pdf"); }
</script>
</body>
        </html>
    
